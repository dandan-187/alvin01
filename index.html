<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Providence Memorial Park Receipt</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');

  body {
    font-family: 'Montserrat', sans-serif;
    margin: 0; padding: 1rem;
    background: #f7f7f7;
    color: #222;
  }
  h1, h2, h3 { margin: 0; }
  .container {
    max-width: 480px;
    margin: 0 auto;
    background: white;
    border-radius: 12px;
    padding: 1rem 1.5rem 2rem;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
  }
  header { text-align: center; color: #b30000; margin-bottom: 1rem; }
  header h1 { font-weight: 900; font-size: 1.8rem; letter-spacing: 1.5px; }
  header h2 { font-weight: 500; font-size: 1.1rem; font-style: italic; margin-top: 4px; color: #a00000; }

  form { margin-bottom: 1.2rem; }
  label { display: block; font-weight: 600; margin: 12px 0 6px 0; }
  input[type=text], input[type=number], select {
    width: 100%; padding: 8px 10px; font-size: 1rem;
    border: 1.8px solid #ccc; border-radius: 8px; box-sizing: border-box;
    transition: border-color 0.3s ease;
  }
  input:focus, select:focus { border-color: #b30000; outline: none; }

  .month-range { display: flex; gap: 10px; }
  .month-range > div { flex: 1; }

  button {
    background-color: #b30000; color: white; border: none; padding: 12px;
    border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer;
    margin-top: 16px; width: 100%; transition: background-color 0.3s ease;
  }
  button:hover { background-color: #850000; }
  button.clear-btn { background-color: #555; margin-top: 10px; }
  button.clear-btn:hover { background-color: #333; }

  /* small Add Balance button */
  .small-btn {
    display: inline-block;
    padding: 6px 10px;
    font-size: 0.85rem;
    border-radius: 8px;
    margin-top: 8px;
    background: #f0ad4e;
    color: #111;
    border: none;
    cursor: pointer;
  }
  .small-btn[disabled] { opacity: 0.5; cursor: not-allowed; }

  /* Messenger button styling */
  #messengerBtn {
    background-color: #0084FF; /* Messenger blue */
    margin-top: 10px;
  }
  #messengerBtn:hover {
    background-color: #006fdd;
  }

  /* Receipt styling */
  #receipt {
    margin-top: 20px; background: #fff8f0; border-radius: 12px; padding: 20px 30px;
    color: #3a3a3a; box-shadow: 0 5px 12px rgba(179,0,0,0.2); font-size: 14px; display: none;
  }
  #receipt h2 { text-align: center; color: #b30000; font-weight: 900; font-size: 1.5rem; margin-bottom: 4px; }
  #receipt .subheading { text-align: center; font-style: italic; color: #8b0000; margin-bottom: 20px; }
  #receipt .info p { margin: 4px 0; }
  #receipt .line { border-bottom: 1px solid #b3000050; margin: 12px 0; }
  #receipt .field-label { font-weight: 700; width: 140px; display: inline-block; color: #8b0000; }
  #receipt .footer { margin-top: 20px; font-size: 13px; color: #660000; text-align: center; line-height: 1.3; }
  #receipt .footer strong { color: #b30000; }
  #receipt .total-line { margin-top: 15px; font-weight: 700; font-size: 1.15rem; text-align: right; color: #b30000; }

  /* Responsive */
  @media (max-width: 520px) {
    .month-range { flex-direction: column; }
    .month-range > div { flex: none; }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Providence Memorial Park</h1>
    <h2>Monthly Grave Maintenance Service</h2>
  </header>

  <form id="inputForm" autocomplete="off">

    <label for="monthlyRate">Monthly Amount (â‚±)</label>
    <input type="number" id="monthlyRate" min="0" step="0.01" placeholder="Enter monthly rate" required />

    <label for="payerName">Name of Payer</label>
    <input type="text" id="payerName" placeholder="Enter payer's full name" required />

    <label for="deceasedName">Name of Deceased</label>
    <input type="text" id="deceasedName" placeholder="Enter deceased's full name" required />

    <label>Payment Period</label>
    <div class="month-range">
      <div>
        <label for="monthFrom" style="font-weight:400; margin-bottom:4px;">From:</label>
        <select id="monthFrom" required>
          <option value="" disabled selected>Select month</option>
          <option>January</option><option>February</option><option>March</option><option>April</option>
          <option>May</option><option>June</option><option>July</option><option>August</option>
          <option>September</option><option>October</option><option>November</option><option>December</option>
        </select>
      </div>
      <div>
        <label for="monthTo" style="font-weight:400; margin-bottom:4px;">To:</label>
        <select id="monthTo" required>
          <option value="" disabled selected>Select month</option>
          <option>January</option><option>February</option><option>March</option><option>April</option>
          <option>May</option><option>June</option><option>July</option><option>August</option>
          <option>September</option><option>October</option><option>November</option><option>December</option>
        </select>
      </div>
    </div>

    <label for="amountPaid">Amount Paid (â‚±)</label>
    <input type="number" id="amountPaid" min="0" step="0.01" placeholder="0.00" readonly />

    <!-- Balance months section (hidden by default) -->
    <div id="balanceMonthsSection" style="display:none; margin-top:12px;">
      <label>Balance Period</label>
      <div class="month-range">
        <div>
          <label for="balMonthFrom" style="font-weight:400; margin-bottom:4px;">From:</label>
          <select id="balMonthFrom">
            <option value="" disabled selected>Select month</option>
            <option>January</option><option>February</option><option>March</option><option>April</option>
            <option>May</option><option>June</option><option>July</option><option>August</option>
            <option>September</option><option>October</option><option>November</option><option>December</option>
          </select>
        </div>
        <div>
          <label for="balMonthTo" style="font-weight:400; margin-bottom:4px;">To:</label>
          <select id="balMonthTo">
            <option value="" disabled selected>Select month</option>
            <option>January</option><option>February</option><option>March</option><option>April</option>
            <option>May</option><option>June</option><option>July</option><option>August</option>
            <option>September</option><option>October</option><option>November</option><option>December</option>
          </select>
        </div>
      </div>

      <label for="balMonthly">Balance Monthly Amount (â‚±)</label>
      <input type="number" id="balMonthly" min="0" step="0.01" placeholder="Balance monthly rate" />
    </div>

    <label for="balance">Balance (â‚±)</label>
    <div style="display:flex; gap:8px; align-items:center;">
      <input type="number" id="balance" min="0" step="0.01" placeholder="0.00" value="0" />
      <button type="button" id="addBalanceBtn" class="small-btn" disabled>Add Balance</button>
      <!-- small hint -->
      <span id="balanceHint" style="font-size:0.85rem;color:#666;margin-left:6px;">Enter &gt;0 then click Add Balance</span>
    </div>

    <button type="button" id="createReceiptBtn">Create Receipt</button>
    <button type="button" id="messengerBtn">Open Messenger</button>
    <button type="button" id="clearBtn" class="clear-btn">Clear</button>
  </form>

  <div id="receipt">
    <h2>ðŸ§¾ Providence Memorial Park</h2>
    <div class="subheading">Monthly Grave Maintenance Service</div>

    <div class="info">
      <p><span class="field-label">Date:</span> <span id="receiptDate"></span></p>
      <p><span class="field-label">Name of Payer:</span> <span id="receiptPayer"></span></p>
      <p><span class="field-label">Name of Deceased:</span> <span id="receiptDeceased"></span></p>
      <p><span class="field-label">Payment Period:</span> <span id="receiptPeriod"></span></p>
      <p><span class="field-label">Amount Paid:</span> â‚±<span id="receiptPaid"></span></p>
      <p id="receiptBalanceRow"><span class="field-label">Balance:</span> â‚±<span id="receiptBalance"></span></p>
    </div>

    <div class="line"></div>

    <div class="footer">
      <p>For inquiries or services such as Bermuda grass planting, grave maintenance, or granite installation and Tent rental with table and chairs, please contact:</p>
      <p><strong>Caretaker Teresa Gaza</strong> â€“ 0965 260 9362</p>
      <p><strong>Caretaker Danilo Gaza</strong> â€“ 0977 683 4583</p>
      <p>Thank you for trusting Providence Memorial Park.</p>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
  // Elements
  const monthlyRateEl = document.getElementById('monthlyRate');
  const monthFromEl = document.getElementById('monthFrom');
  const monthToEl = document.getElementById('monthTo');
  const amountPaidEl = document.getElementById('amountPaid');

  const balanceEl = document.getElementById('balance');
  const addBalanceBtn = document.getElementById('addBalanceBtn');
  const balanceMonthsSection = document.getElementById('balanceMonthsSection');
  const balMonthFromEl = document.getElementById('balMonthFrom');
  const balMonthToEl = document.getElementById('balMonthTo');
  const balMonthlyEl = document.getElementById('balMonthly');

  const createBtn = document.getElementById('createReceiptBtn');
  const clearBtn = document.getElementById('clearBtn');
  const receipt = document.getElementById('receipt');
  const messengerBtn = document.getElementById('messengerBtn');

  // Receipt fields
  const receiptDateEl = document.getElementById('receiptDate');
  const receiptPayerEl = document.getElementById('receiptPayer');
  const receiptDeceasedEl = document.getElementById('receiptDeceased');
  const receiptPeriodEl = document.getElementById('receiptPeriod');
  const receiptPaidEl = document.getElementById('receiptPaid');
  const receiptBalanceEl = document.getElementById('receiptBalance');
  const receiptBalanceRow = document.getElementById('receiptBalanceRow');

  // Utils
  function getCurrentDateFormatted() {
    const d = new Date();
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return d.toLocaleDateString('en-US', options);
  }

  function monthIndex(name) {
    const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    return months.indexOf(name);
  }

  // inclusive month count, supports wrapping to next year
  function calcMonthsCount(fromName, toName) {
    const fromIdx = monthIndex(fromName);
    const toIdx = monthIndex(toName);
    if (fromIdx === -1 || toIdx === -1) return 0;
    if (toIdx >= fromIdx) return toIdx - fromIdx + 1;
    // wrap around year
    return (12 - fromIdx) + (toIdx + 1);
  }

  // Payment calculation
  function calcPaid() {
    const monthly = parseFloat(monthlyRateEl.value);
    const from = monthFromEl.value;
    const to = monthToEl.value;
    if (!isNaN(monthly) && from && to) {
      const mCount = calcMonthsCount(from, to);
      amountPaidEl.value = (mCount * monthly).toFixed(2);
    } else {
      amountPaidEl.value = '';
    }
  }

  // Balance calculation (when balance details are used)
  function calcBalanceFromMonths() {
    const balMonthly = parseFloat(balMonthlyEl.value);
    const bFrom = balMonthFromEl.value;
    const bTo = balMonthToEl.value;
    if (!isNaN(balMonthly) && bFrom && bTo) {
      const mCount = calcMonthsCount(bFrom, bTo);
      const total = (mCount * balMonthly);
      // write to balance input (user can still edit afterwards)
      balanceEl.value = total.toFixed(2);
    }
  }

  // Enable/disable Add Balance button based on balance input value
  function updateAddBalanceButtonState() {
    const val = parseFloat(balanceEl.value);
    if (!isNaN(val) && val > 0) {
      addBalanceBtn.disabled = false;
      document.getElementById('balanceHint').style.opacity = 1;
    } else {
      addBalanceBtn.disabled = true;
      // hide details if currently visible
      balanceMonthsSection.style.display = 'none';
      document.getElementById('balanceHint').style.opacity = 0.7;
    }
  }

  // When Add Balance clicked: show the months area and default balance monthly to payment monthly
  addBalanceBtn.addEventListener('click', () => {
    // show section
    balanceMonthsSection.style.display = 'block';
    // default bal monthly rate to payment monthly if empty
    if (!balMonthlyEl.value || parseFloat(balMonthlyEl.value) === 0) {
      const pm = parseFloat(monthlyRateEl.value);
      if (!isNaN(pm)) balMonthlyEl.value = pm.toFixed(2);
    }
    // attempt to calculate if months already chosen
    calcBalanceFromMonths();
  });

  // Event listeners for payment fields
  monthlyRateEl.addEventListener('input', () => {
    calcPaid();
    // also update balMonthly's default if balance details visible and user hasn't changed it manually
    if (balanceMonthsSection.style.display === 'block') {
      if (!balMonthlyEl.value || parseFloat(balMonthlyEl.value) === 0) {
        const pm = parseFloat(monthlyRateEl.value);
        if (!isNaN(pm)) balMonthlyEl.value = pm.toFixed(2);
      }
    }
  });
  monthFromEl.addEventListener('change', calcPaid);
  monthToEl.addEventListener('change', calcPaid);

  // Event listeners for balance input & balance months
  balanceEl.addEventListener('input', updateAddBalanceButtonState);
  balMonthFromEl.addEventListener('change', calcBalanceFromMonths);
  balMonthToEl.addEventListener('change', calcBalanceFromMonths);
  balMonthlyEl.addEventListener('input', calcBalanceFromMonths);

  // Initialize payment calculation on load
  window.addEventListener('load', () => {
    if (!monthlyRateEl.value) monthlyRateEl.value = '';
    calcPaid();
    updateAddBalanceButtonState();
  });

  // Create receipt
  createBtn.addEventListener('click', () => {
    const monthly = parseFloat(monthlyRateEl.value);
    const payer = document.getElementById('payerName').value.trim();
    const deceased = document.getElementById('deceasedName').value.trim();
    const monthFrom = monthFromEl.value;
    const monthTo = monthToEl.value;
    const amountPaid = parseFloat(amountPaidEl.value) || 0;
    const balance = parseFloat(balanceEl.value) || 0;

    if (!payer || !deceased || !monthFrom || !monthTo || isNaN(monthly)) {
      alert('Please fill out all required fields.');
      return;
    }

    // Payment period string
    let paymentPeriodStr = `${monthFrom} to ${monthTo} (â‚±${monthly.toFixed(2)}/month)`;
    receiptDateEl.textContent = getCurrentDateFormatted();
    receiptPayerEl.textContent = payer;
    receiptDeceasedEl.textContent = deceased;
    receiptPeriodEl.textContent = paymentPeriodStr;
    receiptPaidEl.textContent = amountPaid.toFixed(2);

    if (balance > 0) {
      receiptBalanceEl.textContent = balance.toFixed(2);
      receiptBalanceRow.style.display = 'block';
    } else {
      receiptBalanceRow.style.display = 'none';
    }

    receipt.style.display = 'block';

    // Scroll to receipt
    receipt.scrollIntoView({ behavior: 'smooth' });

    // Automatically save receipt as PNG and trigger download
    html2canvas(receipt, { scale: 2 }).then(canvas => {
      const link = document.createElement('a');
      link.download = 'providence_receipt.png';
      link.href = canvas.toDataURL('image/png');
      document.body.appendChild(link); // Append to body for browser compatibility
      link.click();
      document.body.removeChild(link); // Clean up
    }).catch(error => {
      console.error('Error generating receipt PNG:', error);
      alert('Failed to generate receipt PNG. Please try again.');
    });
  });

  // Clear form and receipt
  clearBtn.addEventListener('click', () => {
    if (confirm('Clear all input fields and receipt?')) {
      document.getElementById('inputForm').reset();
      amountPaidEl.value = '';
      balanceEl.value = '0';
      addBalanceBtn.disabled = true;
      balanceMonthsSection.style.display = 'none';
      receipt.style.display = 'none';
    }
  });

  // Messenger button click: try to open Messenger app, fallback to web
  messengerBtn.addEventListener('click', () => {
    // Messenger URL scheme for app
    const messengerAppUrl = 'fb-messenger://user-thread/';
    // Replace user-thread with a generic open Messenger link for demo; you can add specific user/page id
    // Since no user id provided, open main app scheme to open Messenger home
    // On desktop or if fails, open web Messenger
    const webMessengerUrl = 'https://m.me/';

    // Try to open messenger app by changing window location and detect failure by timeout fallback
    let opened = false;

    function openWebMessenger() {
      window.open(webMessengerUrl, '_blank');
    }

    // Modern approach: use setTimeout to open web after delay if app doesn't open
    const timeout = setTimeout(() => {
      if (!opened) {
        openWebMessenger();
      }
    }, 1500);

    // Try opening Messenger app
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = messengerAppUrl;
    document.body.appendChild(iframe);

    // If user is on desktop, just open web Messenger directly
    if (navigator.userAgent.match(/(Windows|Macintosh|Linux)/i)) {
      clearTimeout(timeout);
      document.body.removeChild(iframe);
      openWebMessenger();
    } else {
      // On mobile: if user switches to app, page visibility changes, clear timeout
      function visibilityChange() {
        if (document.hidden) {
          clearTimeout(timeout);
          opened = true;
          document.removeEventListener('visibilitychange', visibilityChange);
          document.body.removeChild(iframe);
        }
      }
      document.addEventListener('visibilitychange', visibilityChange);
    }
  });
</script>
</body>
</html>
